<!DOCTYPE html>
<html>
<head>
    <title>File Viewer</title>
    <style>
        .content {
            max-width: 100%;
            margin: 20px auto;
            text-align: center;
        }
        .content img {
            max-width: 100%;
            height: auto;
        }
        .content iframe {
            width: 100%;
            height: 90vh;
            border: none;
        }
    </style>
    <script>
        function setupEventSource() {
            const evtSource = new EventSource("/watch-changes");

            evtSource.onmessage = function(event) {
                const data = JSON.parse(event.data);
                console.log("Event received:", data);

                if (data.template_changed) {
                    window.location.reload();
                    return;
                }

                const img = document.getElementById('image-content');
                const iframe = document.getElementById('iframe-content');
                const timestamp = new Date().getTime();

                if (data.type === "file_selected" || data.type === "file_changed") {
                    if (data.is_image) {
                        img.style.display = 'block';
                        iframe.style.display = 'none';
                        img.src = `/current-file?t=${timestamp}`;
                    } else {
                        img.style.display = 'none';
                        iframe.style.display = 'block';
                        iframe.src = `/current-file?t=${timestamp}`;
                    }
                }
            };

            evtSource.onerror = function() {
                console.log("EventSource failed, reconnecting...");
                evtSource.close();
                setTimeout(setupEventSource, 1000);
            };
        }

        window.onload = function() {
            setupEventSource();
        };
    </script>
</head>
<body>
    <div class="content">
        <img id="image-content" src="/current-file" style="display: {{ 'block' if is_image else 'none' }};" alt="Viewed file">
        <iframe id="iframe-content" src="/current-file" style="display: {{ 'block' if not is_image else 'none' }};"></iframe>
    </div>
</body>
</html>